<!-- templates/optimize.html -->
{% extends "base.html" %}

{% block title %}Optimasi - Logistics Optimizer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1><i class="fas fa-cogs"></i> Optimasi Logistik</h1>
        <p class="text-muted">Konfigurasikan parameter dan jalankan optimasi untuk mendapatkan solusi terbaik</p>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>Parameter Optimasi</h5>
            </div>
            <div class="card-body">
                <form id="optimizeForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Population Size</label>
                                <input type="number" class="form-control" name="population_size" value="50" min="10" max="200">
                                <div class="form-text">Ukuran populasi untuk algoritma genetika (10-200)</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Generations</label>
                                <input type="number" class="form-control" name="generations" value="100" min="10" max="500">
                                <div class="form-text">Jumlah generasi untuk evolusi (10-500)</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Harga BBM (Rp/Liter)</label>
                                <input type="number" class="form-control" name="harga_bbm" value="15000" min="10000" max="25000">
                                <div class="form-text">Harga bahan bakar per liter</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Routing Method</label>
                                <select class="form-select" name="use_network_routing">
                                    <option value="true">Network Routing (dengan Hub Cities)</option>
                                    <option value="false">Direct Routing (point-to-point)</option>
                                </select>
                                <div class="form-text">Metode perhitungan rute</div>
                            </div>
                        </div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg" id="startOptimizationBtn">
                            <i class="fas fa-play"></i> Mulai Optimasi
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Status Data</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Barang:</span>
                        <span id="barangCount" class="badge bg-primary">0</span>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Truk:</span>
                        <span id="trukCount" class="badge bg-success">0</span>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Status:</span>
                        <span id="dataStatus" class="badge bg-warning">Checking...</span>
                    </div>
                </div>
                <div class="text-center">
                    <small class="text-muted">
                        Pastikan data barang dan truk sudah diinput sebelum menjalankan optimasi
                    </small>
                </div>
            </div>
        </div>

        <!-- Progress Card -->
        <div class="card mt-3" id="progressCard" style="display: none;">
            <div class="card-header">
                <h5>Progress Optimasi</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Generation:</span>
                        <span id="currentGeneration">0</span>
                    </div>
                    <div class="progress mt-2">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             id="progressBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="text-center">
                    <small class="text-muted" id="progressStatus">Memulai optimasi...</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let optimizationInterval;

// Check data status on page load
document.addEventListener('DOMContentLoaded', function() {
    checkDataStatus();
});

async function checkDataStatus() {
    try {
        // This would normally call an API to get current counts
        // For now, we'll simulate the check
        document.getElementById('barangCount').textContent = '0'; // Replace with actual count
        document.getElementById('trukCount').textContent = '0'; // Replace with actual count

        const hasData = false; // Replace with actual check
        const statusElement = document.getElementById('dataStatus');

        if (hasData) {
            statusElement.textContent = 'Ready';
            statusElement.className = 'badge bg-success';
        } else {
            statusElement.textContent = 'Data Incomplete';
            statusElement.className = 'badge bg-warning';
        }
    } catch (error) {
        console.error('Error checking data status:', error);
    }
}

// Handle optimization form submission
document.getElementById('optimizeForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    // Convert string to boolean for use_network_routing
    data.use_network_routing = data.use_network_routing === 'true';

    try {
        const response = await axios.post('/api/optimize', data);

        if (response.data.success) {
            // Show progress card and start monitoring
            document.getElementById('progressCard').style.display = 'block';
            document.getElementById('startOptimizationBtn').disabled = true;
            document.getElementById('startOptimizationBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Optimasi Berjalan...';

            // Start monitoring progress
            startProgressMonitoring();
        } else {
            alert('Error: ' + response.data.message);
        }
    } catch (error) {
        alert('Error: ' + error.response?.data?.message || error.message);
    }
});

function startProgressMonitoring() {
    optimizationInterval = setInterval(async function() {
        try {
            const response = await axios.get('/api/optimization_status');
            const status = response.data;

            document.getElementById('currentGeneration').textContent =
                `${status.current_generation} / ${document.querySelector('input[name="generations"]').value}`;
            document.getElementById('progressBar').style.width = status.progress + '%';
            document.getElementById('progressStatus').textContent =
                status.running ? 'Optimasi sedang berjalan...' : 'Optimasi selesai!';

            if (!status.running) {
                clearInterval(optimizationInterval);

                // Reset button
                document.getElementById('startOptimizationBtn').disabled = false;
                document.getElementById('startOptimizationBtn').innerHTML = '<i class="fas fa-play"></i> Mulai Optimasi';

                // Show success message and redirect to results
                setTimeout(function() {
                    alert('Optimasi selesai! Redirecting ke halaman hasil...');
                    window.location.href = '/results';
                }, 1000);
            }
        } catch (error) {
            console.error('Error monitoring progress:', error);
            clearInterval(optimizationInterval);
        }
    }, 1000);
}
</script>
{% endblock %}